suite: Secret tests
templates:
  - secret.yaml
tests:
  # Basic Secret tests
  - it: should create a Secret by default
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-garage-secret

  - it: should not create Secret when secret.create is false
    set:
      garage.secret.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom secret name
    set:
      garage.secret.name: custom-secret
    asserts:
      - equal:
          path: metadata.name
          value: custom-secret

  # Secret data tests
  - it: should have rpcSecret key
    asserts:
      - exists:
          path: data.rpcSecret
      - isNotNull:
          path: data.rpcSecret

  - it: should have adminToken key
    asserts:
      - exists:
          path: data.adminToken
      - isNotNull:
          path: data.adminToken

  - it: should use provided rpcSecret
    set:
      garage.secret.rpcSecret: mysecretrpckey
    asserts:
      - exists:
          path: data.rpcSecret

  - it: should use provided adminToken
    set:
      garage.secret.adminToken: myadmintoken
    asserts:
      - exists:
          path: data.adminToken

  # Labels tests
  - it: should include common labels
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: garage
            app.kubernetes.io/instance: RELEASE-NAME

  - it: should include custom common labels
    set:
      commonLabels:
        team: platform
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            team: platform

  # Secret type test
  - it: should have Opaque type
    asserts:
      - equal:
          path: type
          value: Opaque

  # WebUI auth secret tests
  - it: should not have webuiAuthUserPass when webui auth is disabled
    set:
      webui.enabled: true
      webui.auth.enabled: false
    asserts:
      - notExists:
          path: data.webuiAuthUserPass

  - it: should have webuiAuthUserPass when webui auth is enabled with userPassHash
    set:
      webui.enabled: true
      webui.auth.enabled: true
      webui.auth.userPassHash: "admin:$2y$10$abcdef"
    asserts:
      - exists:
          path: data.webuiAuthUserPass

  - it: should fail when webui auth enabled but no userPassHash
    set:
      webui.enabled: true
      webui.auth.enabled: true
      webui.auth.userPassHash: ""
    asserts:
      - failedTemplate:
          errorMessage: "webui.auth.userPassHash is required when auth is enabled. Generate it with: htpasswd -nbBC 10 'username' 'password'"

  - it: should not have webuiAuthUserPass when using existingSecret
    set:
      webui.enabled: true
      webui.auth.enabled: true
      webui.auth.existingSecret: external-secret
    asserts:
      - notExists:
          path: data.webuiAuthUserPass

  - it: should fail when secret.create is false and webui auth enabled without existingSecret
    set:
      garage.secret.create: false
      webui.enabled: true
      webui.auth.enabled: true
    asserts:
      - failedTemplate:
          errorMessage: "webui.auth.existingSecret is required when garage.secret.create is false and webui.auth.enabled is true"
