suite: Extra Resources tests
templates:
  - extra-resources.yaml
tests:
  # Basic Extra Resources tests - empty by default
  - it: should not create any resources by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create single extra resource
    set:
      extraResources:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-configmap
          data:
            key: value
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: extra-configmap
      - equal:
          path: data.key
          value: value

  - it: should create multiple extra resources
    set:
      extraResources:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-configmap
          data:
            key: value
        - apiVersion: v1
          kind: Secret
          metadata:
            name: extra-secret
          type: Opaque
          data:
            password: cGFzc3dvcmQ=
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ConfigMap
        documentIndex: 0
      - isKind:
          of: Secret
        documentIndex: 1

  - it: should create PodDisruptionBudget
    set:
      extraResources:
        - apiVersion: policy/v1
          kind: PodDisruptionBudget
          metadata:
            name: garage-pdb
          spec:
            minAvailable: 2
            selector:
              matchLabels:
                app.kubernetes.io/name: garage
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: metadata.name
          value: garage-pdb
      - equal:
          path: spec.minAvailable
          value: 2

  - it: should create NetworkPolicy
    set:
      extraResources:
        - apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: garage-network-policy
          spec:
            podSelector:
              matchLabels:
                app.kubernetes.io/name: garage
            policyTypes:
              - Ingress
              - Egress
    asserts:
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: garage-network-policy
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  - it: should create ExternalSecret
    set:
      extraResources:
        - apiVersion: external-secrets.io/v1beta1
          kind: ExternalSecret
          metadata:
            name: garage-external-secret
          spec:
            refreshInterval: 1h
            secretStoreRef:
              kind: ClusterSecretStore
              name: vault-backend
            target:
              name: garage-secret
            data:
              - secretKey: rpcSecret
                remoteRef:
                  key: garage/config
                  property: rpc-secret
    asserts:
      - equal:
          path: apiVersion
          value: external-secrets.io/v1beta1
      - isKind:
          of: ExternalSecret
      - equal:
          path: metadata.name
          value: garage-external-secret

  - it: should create HorizontalPodAutoscaler
    set:
      extraResources:
        - apiVersion: autoscaling/v2
          kind: HorizontalPodAutoscaler
          metadata:
            name: garage-hpa
          spec:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: StatefulSet
              name: garage
            minReplicas: 3
            maxReplicas: 10
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 80
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: garage-hpa
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 10
