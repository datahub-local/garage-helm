suite: Workload tests
templates:
  - workload.yaml
tests:
  # Basic StatefulSet deployment tests
  - it: should create a StatefulSet by default
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: spec.replicas
          value: 3
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-garage-headless
      - equal:
          path: spec.podManagementPolicy
          value: OrderedReady

  - it: should create a DaemonSet when specified
    set:
      deployment.kind: DaemonSet
    asserts:
      - isKind:
          of: DaemonSet

  - it: should set replica count correctly
    set:
      deployment.replicaCount: 5
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should set podManagementPolicy to Parallel
    set:
      deployment.podManagementPolicy: Parallel
    asserts:
      - equal:
          path: spec.podManagementPolicy
          value: Parallel

  # Image configuration tests
  - it: should use default image repository and tag from Chart.AppVersion
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "dxflrs/amd64_garage:v2.1.0"

  - it: should use custom image repository and tag
    set:
      image.repository: custom-repo/garage
      image.tag: "v1.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "custom-repo/garage:v1.0.0"

  - it: should set image pull policy
    set:
      image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should set image pull secrets
    set:
      imagePullSecrets:
        - name: my-registry-secret
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: my-registry-secret

  # Service Account tests
  - it: should use default service account name
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-garage

  - it: should use custom service account name
    set:
      serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa

  # Security Context tests
  - it: should set pod security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should set container security context
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: should allow custom pod security context
    set:
      podSecurityContext:
        runAsUser: 2000
        runAsGroup: 2000
        fsGroup: 2000
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 2000

  # Port configuration tests
  - it: should expose all required ports
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 3900
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: s3-api
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 3901
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: rpc
      - equal:
          path: spec.template.spec.containers[0].ports[2].containerPort
          value: 3902
      - equal:
          path: spec.template.spec.containers[0].ports[2].name
          value: s3-web
      - equal:
          path: spec.template.spec.containers[0].ports[3].containerPort
          value: 3903
      - equal:
          path: spec.template.spec.containers[0].ports[3].name
          value: admin

  # Environment variables tests
  - it: should set required environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GARAGE_RPC_SECRET
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-garage-secret
                key: rpcSecret
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GARAGE_ADMIN_TOKEN
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-garage-secret
                key: adminToken

  - it: should use custom secret name for environment variables
    set:
      garage.secret.name: custom-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GARAGE_RPC_SECRET
            valueFrom:
              secretKeyRef:
                name: custom-secret
                key: rpcSecret

  - it: should add custom environment variables
    set:
      environment:
        - name: MY_CUSTOM_VAR
          value: my-value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MY_CUSTOM_VAR
            value: my-value

  # Volume mounts tests
  - it: should mount required volumes
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: meta
            mountPath: /mnt/meta
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: data
            mountPath: /mnt/data
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: configmap
            mountPath: /etc/garage.toml
            subPath: garage.toml

  - it: should add extra volume mounts
    set:
      extraVolumeMounts:
        - name: extra-mount
          mountPath: /extra
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-mount
            mountPath: /extra

  # Volumes tests
  - it: should create configmap volume
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: configmap
            configMap:
              name: RELEASE-NAME-garage-config

  - it: should use emptyDir when persistence is disabled
    set:
      persistence.enabled: false
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: meta
            emptyDir: {}
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            emptyDir: {}

  - it: should use hostPath for DaemonSet
    set:
      deployment.kind: DaemonSet
      persistence.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: meta
            hostPath:
              path: /var/lib/garage/meta
              type: DirectoryOrCreate
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            hostPath:
              path: /var/lib/garage/data
              type: DirectoryOrCreate

  - it: should add extra volumes
    set:
      extraVolumes:
        - name: extra-volume
          emptyDir: {}
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-volume
            emptyDir: {}

  # PVC tests for StatefulSet
  - it: should create volume claim templates for StatefulSet
    asserts:
      - lengthEqual:
          path: spec.volumeClaimTemplates
          count: 2
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: meta
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 100Mi
      - equal:
          path: spec.volumeClaimTemplates[1].metadata.name
          value: data
      - equal:
          path: spec.volumeClaimTemplates[1].spec.resources.requests.storage
          value: 1Gi

  - it: should set custom storage sizes
    set:
      persistence.meta.size: 500Mi
      persistence.data.size: 10Gi
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 500Mi
      - equal:
          path: spec.volumeClaimTemplates[1].spec.resources.requests.storage
          value: 10Gi

  - it: should set storage class for PVCs
    set:
      persistence.meta.storageClass: fast-storage
      persistence.data.storageClass: standard
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: fast-storage
      - equal:
          path: spec.volumeClaimTemplates[1].spec.storageClassName
          value: standard

  # Resource limits tests
  - it: should not set resources by default
    asserts:
      - isEmpty:
          path: spec.template.spec.containers[0].resources

  - it: should set resource limits and requests
    set:
      resources:
        limits:
          cpu: 200m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi

  # Probes tests
  - it: should not set probes by default
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].livenessProbe
      - notExists:
          path: spec.template.spec.containers[0].readinessProbe

  - it: should set liveness probe
    set:
      livenessProbe:
        httpGet:
          path: /health
          port: 3903
        initialDelaySeconds: 10
        periodSeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 3903
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30

  - it: should set readiness probe
    set:
      readinessProbe:
        httpGet:
          path: /health
          port: 3903
        initialDelaySeconds: 5
        periodSeconds: 10
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 3903

  # Node selector, tolerations, affinity tests
  - it: should set node selector
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should set tolerations
    set:
      tolerations:
        - key: "node.kubernetes.io/disk-pressure"
          operator: "Exists"
          effect: "NoSchedule"
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: "node.kubernetes.io/disk-pressure"
      - equal:
          path: spec.template.spec.tolerations[0].operator
          value: "Exists"
      - equal:
          path: spec.template.spec.tolerations[0].effect
          value: "NoSchedule"

  - it: should set affinity
    set:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/e2e-az-name
                    operator: In
                    values:
                      - e2e-az1
    asserts:
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: kubernetes.io/e2e-az-name

  # Labels and annotations tests
  - it: should include common labels in metadata
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: garage
            app.kubernetes.io/instance: RELEASE-NAME

  - it: should include custom common labels
    set:
      commonLabels:
        team: platform
        app.kubernetes.io/part-of: storage
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            team: platform
            app.kubernetes.io/part-of: storage

  - it: should set pod annotations
    set:
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3903"
    asserts:
      - isSubset:
          path: spec.template.metadata.annotations
          content:
            prometheus.io/scrape: "true"
            prometheus.io/port: "3903"

  # Name override tests
  - it: should use fullname override
    set:
      fullnameOverride: my-custom-garage
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-garage

  - it: should use name override
    set:
      nameOverride: custom-name
    asserts:
      - matchRegex:
          path: metadata.name
          pattern: ".*custom-name.*"
