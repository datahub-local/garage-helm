{{- if .Values.clusterConfig.enabled -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "garage.fullname" . }}-configure-script
  labels:
    {{- include "garage.labels" . | nindent 4 }}
stringData:
  configure.sh: |
    #!/bin/sh
    set -e
    
    # Default values
    DEFAULT_ZONE="{{ .Values.clusterConfig.layout.zone | default "dc1" }}"
    DEFAULT_CAPACITY="{{ .Values.clusterConfig.layout.capacity | default .Values.persistence.data.size | default "1T" }}"
    SERVICE_DNS={{ include "garage.fullname" . }}-headless.{{ .Release.Namespace }}.svc.cluster.local

    echo "Waiting for Garage cluster to be ready..."
    sleep 60
    
    # Function to get node ID from metrics
    get_node_id() {
      HOST=$1
      URL="http://$HOST:3903/v2/GetNodeInfo?node=self"
      while true; do
        # Call the admin API and parse the node ID
        RESPONSE=$(wget -q -O - \
          --header "Authorization: Bearer $GARAGE_ADMIN_TOKEN" \
          "$URL" 2>/dev/null)
        ID=$(printf '%s' "$RESPONSE" | sed -n -E 's/.*"nodeId":\s*"([a-fA-F0-9]+)".*/\1/p' | head -n 1)

        if [ -n "$ID" ]; then
          echo "$ID"
          return 0
        fi
        echo "Waiting for $HOST to be ready..."
        sleep 5
      done
    }

    # Resolve Coordinator (Node 0)
    COORD_HOST="{{ include "garage.fullname" . }}-0.${SERVICE_DNS}"
    echo "Resolving coordinator $COORD_HOST..."
    COORD_ID=$(get_node_id $COORD_HOST)
    echo "Coordinator ID: $COORD_ID"
    
    GARAGE_RPC_HOST="$COORD_ID@$COORD_HOST:3901"
    
    # Helper function to run garage commands
    run_garage() {
      /shared/garage -h $GARAGE_RPC_HOST "$@"
    }
    
    echo "Garage is ready."

    # Layout configuration
    {{- if .Values.clusterConfig.layout.enabled }}
    echo "Configuring layout..."
    {{- range $i := until (int .Values.deployment.replicaCount) }}
    NODE_HOST="{{ include "garage.fullname" $ }}-{{ $i }}.${SERVICE_DNS}"
    echo "Resolving node $NODE_HOST..."
    NODE_ID=$(get_node_id $NODE_HOST)
    
    run_garage layout assign -z $DEFAULT_ZONE -c $DEFAULT_CAPACITY $NODE_ID || true
    {{- end }}
    
    run_garage layout show
    
    CURRENT_VERSION=$(run_garage layout show | grep "Current cluster layout version" | awk '{print $5}')
    if [ ! -z "$CURRENT_VERSION" ]; then
       NEXT_VERSION=$((CURRENT_VERSION + 1))
       echo "Applying layout version $NEXT_VERSION"
       run_garage layout apply --version $NEXT_VERSION || true
    fi
    {{- end }}

    # Buckets
    {{- range .Values.clusterConfig.buckets }}
    echo "Creating bucket {{ .name }}..."
    run_garage bucket create {{ .name }} 2>/dev/null || true
    {{- if .public }}
    run_garage bucket website --allow {{ .name }} 2>/dev/null || true
    {{- end }}
    {{- end }}

    # Keys
    {{- range $name, $key := .Values.clusterConfig.keys }}
    {{- if $key.secretName }}
    KEY_ID="$KEY_ID_{{ $name | replace "-" "_" | upper }}"
    SECRET_KEY="$SECRET_KEY_{{ $name | replace "-" "_" | upper }}"
    {{- else }}
    KEY_ID="{{ $key.keyId }}"
    SECRET_KEY="{{ $key.secretKey }}"
    {{- end }}

    echo "Importing key $KEY_ID ($name)..."
    # Validate key ID format (must be GK followed by 24 hex-encoded characters)
    if ! echo "$KEY_ID" | grep -qE '^GK[0-9a-fA-F]{24}$'; then
      echo "ERROR: Invalid key ID format: '$KEY_ID'. Key ID must start with 'GK' followed by 24 hex characters"
      exit 1
    fi
    # Validate secret key format (must be 64 hex-encoded characters for 32 bytes)
    if ! echo "$SECRET_KEY" | grep -qE '^[0-9a-fA-F]{64}$'; then
      echo "ERROR: Invalid secret key format. Secret key must be 64 hex characters (32 bytes)"
      exit 1
    fi
    run_garage key import "$KEY_ID" "$SECRET_KEY" --yes -n "{{ $name }}" || true
    {{- if $key.buckets }}
    {{- range $bucket := $key.buckets }}
    run_garage bucket allow {{ $bucket }} --key "$KEY_ID" --read --write || true
    {{- end }}
    {{- end }}
    {{- end }}

    # Extra commands
    {{- range .Values.clusterConfig.extraCommands }}
    echo "Running extra command: {{ . }}"
    run_garage {{ . }}
    {{- end }}

    sleep 120
{{- end }}
